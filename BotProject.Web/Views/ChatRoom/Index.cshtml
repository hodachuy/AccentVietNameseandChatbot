
@{
    ViewBag.Title = "Index";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<link href="~/assets/client/css/chat-room.css" rel="stylesheet" />
<div class="content">
    <div class="row no-gutters chat-block">
        <!-- begin::chat sidebar -->
        <div class="col-lg-3 chat-sidebar border-right">
            <!-- begin::chat sidebar search -->
            <div class="chat-sidebar-header border-bottom">
                <div class="d-flex">
                    <div class="pr-3">
                        <div class="avatar">
                            <img src="~/assets/client/img/avatar-admin.jpg" class="rounded-circle"
                                 alt="image">
                        </div>
                    </div>
                    <div>
                        <p class="mb-0">Huy Ho</p>
                        <p class="m-0 small text-muted">Agent</p>
                    </div>
                </div>
            </div>
            <!-- begin::chat sidebar search -->
            <!-- end::chat list -->
            <div class="chat-sidebar-content">
                <div class="chat-lists">
                    <div class="list-group list-group-flush">
                        <a href="#" class="list-group-item active d-flex">
                            <div class="pr-3">
                                <span class="avatar avatar-state-secondary">
                                    <span class="avatar-title bg-warning rounded-circle">H</span>
                                </span>
                            </div>
                            <div class="flex-grow- 1">
                                <h6 class="mb-1">HCM</h6>
                                <span class="small text-muted">
                                    <i class="fa fa-image mr-1"></i> Photo
                                </span>
                            </div>
                            <div class="text-right ml-auto">
                                <span class="small text-muted">Yesterday</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item d-flex">
                            <div class="pr-3">
                                <span class="avatar avatar-state-warning">
                                    <img src="~/assets/client/img/avatar-admin.jpg"
                                         class="rounded-circle"
                                         alt="image">
                                </span>
                            </div>
                            <div class="flex-grow- 1">
                                <h6 class="mb-1">
                                    <span>
                                        <img class="css-gkenkv" src="~/assets/client/img/fb-msg-icon-960x960.png" alt="channel-icon">
                                    </span>
                                    HCM
                                </h6>
                                <span class="small text-muted">
                                    <i class="fa fa-image mr-1"></i> Photo
                                </span>
                            </div>
                            <div class="text-right ml-auto">
                                <span class="small text-muted">Yesterday</span>
                            </div>
                        </a>
                        <a href="#" class="list-group-item d-flex">
                            <div class="pr-3">
                                <span class="avatar avatar-state-warning">
                                    <img src="~/assets/client/img/avatar-admin.jpg"
                                         class="rounded-circle"
                                         alt="image">
                                </span>
                            </div>
                            <div class="flex-grow- 1">
                                <h6 class="mb-1">
                                    <span>
                                        <img class="css-gkenkv" src="~/assets/client/img/zalo-msg-icon.jpg" alt="channel-icon">
                                    </span>
                                    HCM
                                </h6>
                                <span class="small text-muted">
                                    <i class="fa fa-image mr-1"></i> Photo
                                </span>
                            </div>
                            <div class="text-right ml-auto">
                                <span class="small text-muted">Yesterday</span>
                            </div>
                        </a>
                    </div>
                </div>
            </div>
            <!-- end::chat list -->
        </div>
        <!-- end::chat sidebar -->
        <!-- begin::chat content -->
        <div class="col-lg-6 chat-content border-right">
            <!-- begin::chat header -->
            <div class="chat-header border-bottom">
                <div class="d-flex align-items-center">
                    <div class="pr-3">
                        <span class="avatar avatar-state-secondary">
                            <span class="avatar-title bg-warning rounded-circle">H</span>
                        </span>
                    </div>
                    <div>
                        <p class="mb-0">HCM</p>
                        <div class="m-0 small text-success">typing...</div>
                    </div>
                    <div class="ml-auto">
                        <ul class="nav align-items-center">
                            <li class="mr-4 d-sm-inline d-none">
                                <a href="#" title="" data-toggle="tooltip" data-original-title="Start Video Call">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-video width-18 height-18"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                                </a>
                            </li>
                            <li class="mr-4 d-sm-inline d-none">
                                <a href="#" title="" data-toggle="tooltip" data-original-title="Start Voice Call">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-phone-call width-18 height-18"><path d="M15.05 5A5 5 0 0 1 19 8.95M15.05 1A9 9 0 0 1 23 8.94m-1 7.98v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg>
                                </a>
                            </li>
                            <li class="d-sm-inline d-none">
                                <a href="#" title="" data-toggle="tooltip" data-original-title="Add to Contact">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-user-plus width-18 height-18"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                                </a>
                            </li>
                            <li class="ml-4 mobile-chat-close-btn">
                                <a href="#" class="btn btn-sm btn-danger">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x width-18 height-18"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- end::chat header -->
            <!-- begin::messages -->
            <div class="messages">
                <div class="message-item">
                    <div class="message-avatar">
                        <div class="message-avatar-customer">
                            <div class="pr-3">
                                <span class="message-avatar-item avatar">
                                    <span class="avatar-title bg-warning rounded-circle">H</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="message-item-content">Hi!</div>
                    <span class="time small text-muted font-italic">02:30 PM</span>
                </div>
                <div class="message-item me">
                    <div class="message-avatar">
                        <div class="message-avatar-customer">
                            <div class="pl-3">
                                <span class="message-avatar-item avatar">
                                    <span class="avatar-title bg-warning rounded-circle">H</span>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="message-item-content">
                        Lorem ipsum dolor sit amet, consectetur adipisicing elit.
                        Exercitationem fuga iure iusto libero, possimus quasi quis repellat sint tempora ullam!
                    </div>
                    <span class="time small text-muted font-italic">Yesterday</span>
                </div>
                <div class="message-item">
                    <div class="message-avatar">
                        <div class="message-avatar-customer">
                            <div class="pr-3">
                                <span class="message-avatar-item avatar">
                                    <img src="~/assets/client/img/avatar-admin.jpg" alt="image" class="rounded-circle">
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="message-item-content">Hello! How are you today?</div>
                    <span class="time small text-muted font-italic">02:30 PM</span>
                </div>
                <div class="message-item me">
                    <div class="message-avatar">
                        <div class="message-avatar-customer">
                            <div class="pl-3">
                                <span class="message-avatar-item avatar">
                                    <img src="~/assets/client/img/avatar-admin.jpg" alt="image" class="rounded-circle">
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="message-item-content">Lorem ipsum dolor sit.</div>
                    <span class="time small text-muted font-italic">02:30 PM</span>
                </div>
                <div class="message-item">
                    <div class="message-item-content d-flex">
                        <i class="ti-file mr-2 font-size-20 mt-2"></i>
                        <div>
                            <div>important_documents.pdf <i class="text-muted small">(50KB)</i></div>
                            <ul class="list-inline small">
                                <li class="list-inline-item"><a href="#">Download</a></li>
                                <li class="list-inline-item"><a href="#">View</a></li>
                            </ul>
                        </div>
                    </div>
                    <span class="small text-muted font-italic">02:30 PM</span>
                </div>
                <div class="message-item me">
                    <div class="message-item-content">Lorem ipsum dolor sit.</div>
                    <span class="time small text-muted font-italic">02:30 PM</span>
                </div>
                <div class="message-item">
                    <div class="message-item-content">Lorem ipsum dolor sit.</div>
                    <span class="time small text-muted font-italic">02:30 PM</span>
                </div>
                <div class="message-item me message-media">
                    <img src="http://nago.laborasyon.com/demos/assets/media/image/photo1.jpg" alt="image">
                    <span class="time small text-muted font-italic">02:30 PM</span>
                </div>
                <div class="message-item message-item-divider">
                    <span>Today</span>
                </div>
                <div class="message-item">
                    <div class="message-item-content">Lorem ipsum dolor sit.</div>
                    <span class="time small text-muted font-italic">02:30 PM</span>
                </div>
            </div>
            <!-- end::messages -->
            <!-- begin::chat footer -->
            <div class="chat-footer border-top">
                <div class="d-flex">
                    <button class="btn btn-outline-light mr-2" type="button" title="Emoji"
                            data-toggle="tooltip">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-smile width-15 height-15"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                    </button>
                    <div class="flex-grow-1">
                        <input type="text" class="form-control" id="input-msg-text" placeholder="Nhập tin nhắn...">
                    </div>
                    <div class="chat-footer-buttons d-flex">
                        <button class="btn btn-primary" type="submit">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-send width-15 height-15"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                        <button class="btn btn-outline-light" type="button" title="Attach files"
                                data-toggle="tooltip">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather feather-paperclip width-15 height-15"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path></svg>
                        </button>
                    </div>
                </div>
            </div>
            <!-- end::chat footer -->

        </div>
        <!-- begin::chat content -->
        <!--begin:: chat sidebar customer-->
        <div class="col-lg-3 chat-sidebar">
            <!-- begin::chat sidebar search -->
            <div class="chat-sidebar-header border-bottom">
                <div class="d-flex">
                    <div class="pr-3">
                        <p class="mb-0">Thông tin</p>
                        <p class="m-0 small text-muted">Customer</p>
                    </div>
                </div>
            </div>
            <!-- begin::chat sidebar search -->
            <!-- end::chat list -->
            <div class="chat-sidebar-content">
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-3">
                                <div class="pr-3">
                                    <span class="avatar avatar-state-secondary">
                                        <span class="avatar-title bg-warning rounded-circle">H</span>
                                    </span>
                                </div>
                            </div>
                            <div class="col-9">
                                <h3>HCM</h3>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12 text-dark font-size-13"><i class="fa fa-clock"></i> 4:40 pm  local time</div>
                            <div class="col-12 text-dark font-size-13"><i class="fa fa-map-marker-alt"></i> Ho Chi Minh City, Ho Chi Minh, Vietnam</div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <div id="map" class="map css-181kzs5 css-ahr9p47" style="height:220px;"></div>

                            </div>
                            @*<div data-test="user-data-map" class="css-181kzs5 css-ahr9p47">
                                    <div id="map" class="cusMap"></div>
                                </div>*@
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">Thiết bị</h6>
                        <div class="row">
                            <div class="col-12 font-size-13"><span class="text-muted">IP Address: </span><span>192.168.1.1</span></div>
                            <div class="col-12 font-size-13"><span class="text-muted">OS/Device: </span><span>iOS (13.3)</span></div>
                            <div class="col-12 font-size-13"><span class="text-muted">Browser: </span><span>Chrome (71.0.3578.89)</span></div>
                            <div class="col-12 font-size-13"><span class="text-muted">User agent: </span><span>Mozilla/5.0 (iPhone; CPU iPhone OS 13_3 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) CriOS/71.0.3578.89 Mobile/15E148 Safari/605.1</span></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- end::chat list -->
        </div>
        <!--end:: chat sidebar customer-->
    </div>
</div>
@section footerJS{
    <script src="~/Scripts/jquery.signalR-2.4.0.js"></script>
    <script src="~/signalr/hubs"></script>

    <script src="~/static/js/app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.nicescroll/3.7.6/jquery.nicescroll.js"></script>
    <script>
        $(document).ready(function () {
            var wind_ = $(window),
            body_ = $('body');
            if (wind_.width() >= 992) {

                $('.chat-block .chat-sidebar .chat-sidebar-content').niceScroll();
                $('.chat-block .chat-sidebar-customer .chat-sidebar-content').niceScroll();
                var chat_messages = $('.chat-block .chat-content .messages');

                if (chat_messages.length) {
                    chat_messages.niceScroll({
                        horizrailenabled: false
                    });
                    chat_messages.getNiceScroll(0).doScrollTop(chat_messages.get(0).scrollHeight, -1);
                }
            }
        })

    </script>
    <script type="text/javascript" src="//maps.google.com/maps/api/js?sensor=false&key=AIzaSyAfx5a8yx5MqeGoTS3ierzoe35TXoX0ZOY&libraries=places"></script>
    <script>
        $(document).ready(function () {
            initMap();
        })

        function initMap() {
            var posVietNam = { lat: 10.8230, lng: 106.6296 };
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 8,
                center: posVietNam,
                mapTypeControl: false,
                zoomControl: false,
                scaleControl: false,
                streetViewControl: false,
                rotateControl: false,
                fullscreenControl: false
            });
            var image = {
                url: "/assets/client/img/gmap_marker.png",
                anchor: new google.maps.Point(25, 25),
                scaledSize: new google.maps.Size(25, 25)
            };
            marker = new google.maps.Marker({
                map: map,
                draggable: false,
                animation: google.maps.Animation.DROP,
                position: posVietNam,
                //icon: image
            });
            //google.maps.event.addListener(marker, 'dragend', function (event) {
            //    document.getElementById("Latitude").value = this.getPosition().lat();
            //    document.getElementById("Longitude").value = this.getPosition().lng();
            //});
            //autocomplete = new google.maps.places.Autocomplete((document.getElementById('address')), {types: ['geocode'] });
            //var input = document.getElementById('Address');
            //autocomplete = new google.maps.places.Autocomplete(input);
            //autocomplete.addListener('place_changed', fillInAddress);
        }

        function fillInAddress() {
            // Get the place details from the autocomplete object.
            var place = autocomplete.getPlace();
            document.getElementById("LatiLongTude").value = place.geometry.location.lat() + "," + place.geometry.location.lng();
            var pos = { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() };
            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: 18,
                center: pos
            }); var image = {
                url: "/assets/client/img/gmap_marker_active.png",
                anchor: new google.maps.Point(25, 25),
                scaledSize: new google.maps.Size(45, 45)
            };
            marker = new google.maps.Marker({
                map: map,
                draggable: false,
                animation: google.maps.Animation.DROP,
                position: pos,
                //icon: image
            });
            google.maps.event.addListener(marker, 'dragend', function (event) {
                document.getElementById("LatiLongTude").value = this.getPosition().lat() + "," + this.getPosition().lng();
            });
        }
    </script>
    <script>
            var encryptedUrl = CryptoJS.AES.encrypt(_Host, "Secret Passphrase").toString();
            var encryptedUserID = CryptoJS.AES.encrypt($("#userId").val(), "Secret Passphrase").toString();
            var encryptedBotID = CryptoJS.AES.encrypt('5039', "Secret Passphrase").toString();
            lacviet.load('' + encryptedUrl + '', '' + encryptedUserID + '', '' + encryptedBotID + '', 'U2FsdGVkX19D5jsWIYosQVQ4bBWt2cjbzgkJbDAOSB+Igj5G2vGw1bAq+sh1P/Yc')
    </script>

    <script>
        var objHub = $.connection.chatHub;
        $.connection.hub.logging = true;
        $.connection.hub.start({ transport: ['longPolling', 'webSockets'] });
        $.connection.hub.start().done(function () {
            console.log('signalR started')
        });
        $.connection.hub.error(function (error) {
            console.log('SignalR error: ' + error)
        });
        var tryingToReconnect = false;
        $.connection.hub.reconnecting(function () {
            tryingToReconnect = true;
            console.log('SingalR connect đang kết nối lại')
            $.connection.hub.start().done(function () {
            });
        });
        $.connection.hub.reconnected(function () {
            tryingToReconnect = false;
            console.log('SingalR connect đã kết nối lại')
        });
        $.connection.hub.disconnected(function () {
            console.log('SingalR connect ngắt kết nối')
            if (tryingToReconnect) {
                setTimeout(function () {
                    console.log('SingalR connect đang khởi động lại')
                    $.connection.hub.start({ transport: ['longPolling', 'webSockets'] });
                    $.connection.hub.start().done(function () {});
                }, 5000); // Restart connection after 5 seconds.
            }
        });

        objHub.client.receiveMessage = function (user, message) {
            console.log(message);
        }
    </script>
}